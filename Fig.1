%%
load('/Users/yingyingfeng/Downloads/Data/Paleo3bs_Project/sst_idx_850-2005_ILME_FULL_15ens.mat')
sst_idx_real = sst_idx;
sst_idx_real(:,1:5,:) = sst_idx_real(:,1:5,:) - 273.15; 
sst_idx_real(:,7:11,:) = sst_idx_real(:,7:11,:) - 273.15; 

 data_series = nan(1156,8,15);
for irun = 1:size(sst_idx_real,3)
    sst_idx_run = sst_idx_real(:,:,irun);
    %Nino
    Nino_mon_re = reshape(sst_idx_run(:,1),12,size(sst_idx_run,1)./12);
    Nino_cli = nanmean(Nino_mon_re(:,1021:1156),2);
    Nino_cli_rep = repmat(Nino_cli,1,1156);
    Nino_ano = Nino_mon_re - Nino_cli_rep;
    Nino_raw = reshape(Nino_ano,12*1156,1);
    Nino_raw_mov = movmean(Nino_raw,5);
    Nino_mov_re = reshape(Nino_raw_mov,12,1156);
    Nino_series = squeeze(nanmean([Nino_mov_re(12,1:end-1);Nino_mov_re(1:2,2:end)],1))';

    %ATL3
    ATL3_mon_re = reshape(sst_idx_run(:,9),12,size(sst_idx_run,1)./12);
    ATL3_series = squeeze(nanmean([ATL3_mon_re(12,1:end-1);ATL3_mon_re(1:2,2:end)],1))';

    %TNA
    TNA_mon_re = reshape(sst_idx_run(:,2),12,size(sst_idx_run,1)./12);
    TNA_series = nanmean(TNA_mon_re(3:5,:),1)';

    %AMO
    AMO_mon_re = reshape(sst_idx_run(:,11),12,size(sst_idx_run,1)./12);
    AMO_series = nanmean(AMO_mon_re(1:12,:),1)';

    %IOB
    IOB_mon_re = reshape(sst_idx_run(:,3),12,size(sst_idx_run,1)./12);
    IOB_series = nanmean(IOB_mon_re(3:5,:),1)';

    %WTIO
    WTIO_mon_re = reshape(sst_idx_run(:,4),12,size(sst_idx_run,1)./12);
    WTIO_series = nanmean(WTIO_mon_re(9:11,:),1)';

    %ETIO
    ETIO_mon_re = reshape(sst_idx_run(:,5),12,size(sst_idx_run,1)./12);
    ETIO_series = nanmean(ETIO_mon_re(9:11,:),1)';
    %IOD
    IOD_series = WTIO_series - ETIO_series;

   
    data_series(1:end-1,1,irun) = Nino_series;
    data_series(:,2,irun) = TNA_series;
    data_series(1:end-1,3,irun) = ATL3_series;
    data_series(:,4,irun) = AMO_series;

    data_series(:,5,irun) = IOB_series;
    data_series(:,6,irun) = IOD_series;
    data_series(:,7,irun) = WTIO_series;
    data_series(:,8,irun) = ETIO_series;
end
clearvars -except data_series;

%%
load  /Users/yingyingfeng/Downloads/Data/Paleo3bs_Project/sst_idx_1870-2005_Hadisst_UCSB_region.mat sst_idx_obs;
sst_idx = sst_idx_obs(:,1:11); clear sst_idx_obs;

sst_idx_real = sst_idx;
sst_idx_run = sst_idx;
%Nino
Nino_mon_re = reshape(sst_idx_run(:,1),12,size(sst_idx_run,1)./12);
Nino_cli = nanmean(Nino_mon_re,2);
Nino_cli_rep = repmat(Nino_cli,1,136);
Nino_cli_ano = Nino_mon_re - Nino_cli_rep;
Nino_series_raw = reshape(Nino_cli_ano,12*136,1);
Nino_mov = movmean(Nino_series_raw,5);
Nino_ano_fn = reshape(Nino_mov,12,136);
Nino_series = squeeze(nanmean([Nino_ano_fn(12,1:end-1);Nino_ano_fn(1:2,2:end)],1))';

%TNA
TNA_mon_re = reshape(sst_idx_run(:,2),12,size(sst_idx_run,1)./12);
TNA_series = nanmean(TNA_mon_re(3:5,:),1)';
%IOB
IOB_mon_re = reshape(sst_idx_run(:,3),12,size(sst_idx_run,1)./12);
IOB_series = nanmean(IOB_mon_re(3:5,:),1)';
IOB_fall_series = nanmean(IOB_mon_re(9:11,:),1)';
AMO_mon_re = reshape(sst_idx_run(:,11),12,size(sst_idx_run,1)./12);
AMO_series = nanmean(AMO_mon_re(1:12,:),1)';

%WTIO
WTIO_mon_re = reshape(sst_idx_run(:,4),12,size(sst_idx_run,1)./12);
WTIO_series = nanmean(WTIO_mon_re(9:11,:),1)';

%ETIO
ETIO_mon_re = reshape(sst_idx_run(:,5),12,size(sst_idx_run,1)./12);
ETIO_series = nanmean(ETIO_mon_re(9:11,:),1)';
%IOD
IOD_series = WTIO_series - ETIO_series;

yr_inum = 1:1126;
color_line =  [[0 73 195]./255;  [0 116 195]./255; [100 30 181]./255;  [103, 116, 176]./255;   [0.4 0.4 0.4]];
color_patch = [[0 73 195]./255;  [0 116 195]./255; [100 30 181]./255;  [103, 116, 176]./255;   [0.3 0.3 0.3]];

clearvars -except data_series IOD_series Nino_series;

%% MME的Granger
 load Revise_Granger_NINOIOD_30yr_1870-2005_LME.mat;
 LME = F21;  clear F21;

 load Revise_Granger_NINOIOD_30yr_obs_1870_2005.mat;
 Obs = F21; clear F21;
%%
 page_width = 25; page_height = 25;
 figure('Units','centimeters',...
     'position',[0 0 page_width page_height],...
     'PaperPosition',[0 0 page_width page_height],...
     'color',[1 1 1]);

 xstart = 0.1 ; ystart = 0.05;
 height = 0.15; width =0.4; epsx = 0.02;  epsy = 0.00;
 nrow = 3; ncol = 1;
 pos = zeros(nrow*ncol,4);
 for r0 = 1:nrow
     for c = 1:ncol
         n = (r0-1)*ncol+c;
         pos(n,1) = xstart + (c-1)*width + (c-1)*epsx;
         pos(n,2) = 1 - (ystart + r0*height + (r0-1)*epsy);
         pos(n,3) = width;
         pos(n,4) = height;
     end
 end

yr_inum = 1:1126;
color_line =  [[0 116 195]./255;  [0 116 195]./255; [100 30 181]./255;  [103, 116, 176]./255;   [0.4 0.4 0.4]];
color_patch = [[192 220 240]./255;  [0 116 195]./255; [100 30 181]./255;  [103, 116, 176]./255;   [0.3 0.3 0.3]];
Label = {'a','b','c','d','e'};

for inum = 1:3

    ax= axes('Position',pos(inum,:),'Color','none');

    if inum ==3
        set(ax, 'XLim',[1900 2000], ...
            'XTick',1880:20:2005, ...
            'XTickLabel',string(1880:20:2005), ...
            'TickDir','out', ...
            'TickLength',[0.01/0.5, 0], ...
            'FontName','Helvetica', ...
            'FontSize',12);
    else
        set(ax, 'XLim',[1900 2000], ...
            'XTick',1880:20:2005, ...
            'TickDir','out', ...
            'TickLength',[0.01/0.5, 0], ...
            'FontName','Helvetica', ...
            'FontSize',12, ...
            'XTickLabel',[]);
    end
    hold on;
    clear tmp;
    clear tmp_obs;

    if inum==1
        set(ax, 'YLim',[-2 3],'YTick',-1:1:2, 'TickDir','out','TickLength',[0.01/0.5, 0]);

        tmp =   squeeze(data_series(1021:1155,1,:));
        hold on;
        years = (1871:2005)';   % 135×1

        % 计算每一年 15 个 ensemble 的统计量
        ens_mean = mean(tmp, 2);        % 135×1，逐年平均
        ens_min  = ens_mean -std(tmp, [], 2);     % 135×1，逐年最小
        ens_max  = ens_mean + std(tmp, [], 2);     % 135×1，逐年最大
        X = [years; flipud(years)];         % 先上边，再倒序回来
        Y = [ens_min; flipud(ens_max)];     % 下边是min，上边是max

        % 画灰色阴影
        fh = fill(ax,X, Y,  color_patch(inum,:),'FaceAlpha',0.25,'EdgeColor','none','EdgeAlpha',0.4,'Linestyle','--');            % 半透明，让中间的线看得清

        % fh = fill([850+6:850+1150, fliplr(850+6:850+1150)], [(data_series_avg(6:1150,1)+avg_std(6:1150,1))', fliplr((data_series_avg(6:1150,1)-avg_std(6:1150,1))')], color_patch(inum,:));
        % fh = fill([1871:2005, fliplr(1871:2005)], [(max(tmp,0,2))', fliplr(min(tmp,0,2)')], color_patch(inum,:));
        plot(ax,1871:2005, nanmean(tmp,2) , '-', 'LineWidth', 1.5, 'Color', color_line(1,:),  'LineJoin' ,'miter'); %855-1999
        hold on;
        plot(ax,1871:2005, Nino_series, '-', 'Color', [210 210 210]./255, 'LineWidth', 1.5, 'LineJoin' ,'miter');

    end

        if inum==2
            set(ax, 'YLim',[-3 3],'YTick',-2:1:2, 'TickDir','out','TickLength',[0.01/0.5, 0]);
            tmp =squeeze(data_series(1021:1156,6,:));
            tmp_obs =  [];
            tmp_obs = IOD_series;
            tmp(tmp==0) = nan;
            tmp_obs(tmp_obs==0) = nan;

            tmp_ano = tmp - repmat(nanmean(tmp,1),136,1);
            tmp_ano_obs = tmp_obs - nanmean(tmp_obs);
            avg_std = std(tmp,0,2);
            avg_std_obs = std(tmp_obs,0,2);

            years = (1870:2005)';   % 135×1
            ens_mean = mean(tmp_ano, 2);        % 135×1，逐年平均
            ens_min  =ens_mean - std(tmp_ano, [], 2);     % 135×1，逐年最小
            ens_max  = ens_mean + std(tmp_ano, [], 2);     % 135×1，逐年最大
            X = [years; flipud(years)];         % 先上边，再倒序回来
            Y = [ens_min; flipud(ens_max)];     % 下边是min，上边是max
            hold on;
            fh = fill(ax,X, Y,  color_patch(inum,:),'FaceAlpha',0.25,'EdgeColor','none','EdgeAlpha',0.25,'Linestyle','--');            % 半透明，让中间的线看得清
            set(fh,'FaceColor', color_patch(1,:),'FaceAlpha',0.25,'EdgeColor','none','EdgeAlpha',0.4,'Linestyle','--');
            hold on;
            plot(ax,1870:2005, nanmean(tmp_ano,2), '-', 'LineWidth', 1.5, 'Color', color_line(1,:),  'LineJoin' ,'miter'); %855-1999
            hold on;
            plot(ax,1870:2005, tmp_ano_obs, '-', 'Color', [210 210 210]./255, 'LineWidth', 1.5, 'LineJoin' ,'miter');      
        end


    if inum==3
     set(ax, 'YLim',[-0.04 0.05],'YTick',-0.02:0.02:0.04, 'TickDir','out','TickLength',[0.01/0.5, 0]);

    %
    LME_ano = LME-nanmean(LME(:));
    fh = fill([1870+15:2005-15, fliplr(1870+15:2005-15)], [(nanmean(LME_ano(16:121,:),2)+nanstd(LME_ano(16:121,:),0,2))', fliplr((nanmean(LME_ano(16:121,:),2)-nanstd(LME_ano(16:121,:),0,2))')], color_patch(inum,:));
    set(fh,'FaceColor', color_patch(1,:),'FaceAlpha',0.25,'EdgeColor','none','EdgeAlpha',0.4,'Linestyle','--');
    plot(ax,1870:2005, nanmean(LME_ano,2), '-',  'LineWidth', 1.5, 'LineJoin' ,'miter', 'Color',color_line(1,:)); %855-1999
    hold on;
    plot(ax,1870:2005, Obs-nanmean(Obs), '-', 'Color',[210 210 210]./255, 'LineWidth', 1.5, 'LineJoin' ,'miter');  
    end

    box off; grid on;
    ax=gca;
    axes('position',ax.Position,'box','on','ytick',[],'xtick',[],'color','none');
    if inum==1 || inum==2
        ylabel('SSTA (\circC)', 'fontname','Helvetica','fontsize',12)
    else
        ylabel('G-causality', 'fontname','Helvetica','fontsize',12)
    end
end

img =gcf;
print(img, '-dtiff', '-r600', 'Figure_Nino_IOD_MME_v1.tif');
