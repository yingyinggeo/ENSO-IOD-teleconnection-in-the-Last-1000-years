load /Users/yingyingfeng/Downloads/Data/Paleo3bs_Project/sst_idx_1940-2022_Hadisst_UCSB_region.mat sst_idx_obs;
sst_idx = sst_idx_obs(:,1:9); clear sst_idx_obs;

for inum = 1
    nino_monthly = movmean(sst_idx(241:792,1),5); %1960:2005;
    nino_monthly_re = reshape(nino_monthly,12,size(nino_monthly,1)./12);
    nino_season_avg = nanmean(nino_monthly_re,2);
    nino_season_avg_rep = repmat(nino_season_avg,1,size(nino_monthly,1)./12);
    nino_monthly_ano = nino_monthly_re - nino_season_avg_rep;

    nino_idx = detrend(nanmean([nino_monthly_ano(12,1:end-1);nino_monthly_ano(1:2,2:end)],1))';
    nino_idx_1  = nino_idx;
    nino_monthly_ano_1 = nino_monthly_ano;
    nino_yr = find(nino_idx_1>(nanmean(nino_idx_1)+1.5*nanstd(nino_idx_1)));
    for ical = 1:size(nino_yr,1)
        nino_yr_plot = [nino_monthly_ano_1(:,nino_yr(ical)-1);nino_monthly_ano_1(:,nino_yr(ical));nino_monthly_ano_1(:,nino_yr(ical)+1);nino_monthly_ano_1(:,nino_yr(ical)+2)];
        plot_final(:,ical) = nino_yr_plot;
        clear nino_yr_plot;
    end
end

for inum = 2
    TNA_monthly =sst_idx(241:792,2); %1960:2005;
    TNA_monthly_re = reshape(TNA_monthly,12,size(TNA_monthly,1)./12);
    TNA_season_avg = nanmean(TNA_monthly_re,2);
    TNA_season_avg_rep = repmat(TNA_season_avg,1,size(TNA_monthly,1)./12);
    TNA_monthly_ano = TNA_monthly_re - TNA_season_avg_rep;

    for ical = 1:size(nino_yr,1)
       TNA_nino_yr_plot = [TNA_monthly_ano(:,nino_yr(ical)-1);TNA_monthly_ano(:,nino_yr(ical));TNA_monthly_ano(:,nino_yr(ical)+1);TNA_monthly_ano(:,nino_yr(ical)+2)];
        plot_final_TNA(:,ical) = TNA_nino_yr_plot;
        clear nino_yr_plot;
    end     
end

for inum = 3
    IOB_monthly =sst_idx(241:792,6); %1960:2005;
    IOB_monthly_re = reshape(IOB_monthly,12,size(IOB_monthly,1)./12);
    IOB_season_avg = nanmean(IOB_monthly_re,2);
    IOB_season_avg_rep = repmat(IOB_season_avg,1,size(IOB_monthly,1)./12);
    IOB_monthly_ano = IOB_monthly_re - IOB_season_avg_rep;

    for ical = 1:size(nino_yr,1)
       IOB_nino_yr_plot = [IOB_monthly_ano(:,nino_yr(ical)-1);IOB_monthly_ano(:,nino_yr(ical));IOB_monthly_ano(:,nino_yr(ical)+1);IOB_monthly_ano(:,nino_yr(ical)+2)];
        plot_final_IOB(:,ical) = IOB_nino_yr_plot;
        clear nino_yr_plot;
    end     
end

save phase_lock_Obs_IOD.mat plot_final plot_final_IOB plot_final_TNA plot_final_IOB;
clear;

%%
load('/Users/yingyingfeng/Downloads/Data/Paleo3bs_Project/sst_idx_850-2005_ILME_FULL_15ens.mat');
plot_final_LME = nan(48,6,15);
for inum = 1:15
    nino_monthly = movmean(sst_idx(13321:end,1,inum),5)-273.15; %13081 1940-2005; 1960: 13321
    nino_monthly_re = reshape(nino_monthly,12,size(nino_monthly,1)./12);
    nino_season_avg = nanmean(nino_monthly_re,2);
    nino_season_avg_rep = repmat(nino_season_avg,1,size(nino_monthly,1)./12);
    nino_monthly_ano = nino_monthly_re - nino_season_avg_rep;

    nino_idx = detrend(nanmean([nino_monthly_ano(12,1:end-1);nino_monthly_ano(1:2,2:end)],1))';
    nino_idx_1  = nino_idx;
    nino_monthly_ano_1 = nino_monthly_ano;
    nino_yr = find(nino_idx_1>(nanmean(nino_idx_1)+1.5*nanstd(nino_idx_1)));
    nino_yr(nino_yr==1) = []; nino_yr(nino_yr==45) = [];
      for ical = 1:size(nino_yr,1)
        nino_yr_plot = [nino_monthly_ano_1(:,nino_yr(ical)-1);nino_monthly_ano_1(:,nino_yr(ical));nino_monthly_ano_1(:,nino_yr(ical)+1);nino_monthly_ano_1(:,nino_yr(ical)+2)];
        plot_final_LME(:,ical,inum) = nino_yr_plot;
        clear nino_yr_plot;
      end
      clear nino_yr; clear nino_monthly_ano_1; clear nino_idx_1 ; clear nino_idx; clear nino_monthly_ano; clear nino_season_avg_rep; clear nino_season_avg; clear nino_monthly_re; clear nino_monthly;
end
save LME_Phase_lock_nino.mat plot_final_LME;
clear; clc;

load('/Users/yingyingfeng/Downloads/Data/Paleo3bs_Project/sst_idx_850-2005_ILME_FULL_15ens.mat');
TNA_nino_plot_final_LME = nan(48,6,15);
for inum = 1:15
    TNA_monthly = sst_idx(13321:end,2,inum)-273.15; %13081 1940-2005; 1960: 13321
    TNA_monthly_re = reshape(TNA_monthly,12,size(TNA_monthly,1)./12);
    TNA_season_avg = nanmean(TNA_monthly_re,2);
    TNA_season_avg_rep = repmat(TNA_season_avg,1,size(TNA_monthly,1)./12);
    TNA_monthly_ano = TNA_monthly_re - TNA_season_avg_rep;

    nino_monthly = movmean(sst_idx(13321:end,1,inum),5)-273.15; %13081 1940-2005; 1960: 13321
    nino_monthly_re = reshape(nino_monthly,12,size(nino_monthly,1)./12);
    nino_season_avg = nanmean(nino_monthly_re,2);
    nino_season_avg_rep = repmat(nino_season_avg,1,size(nino_monthly,1)./12);
    nino_monthly_ano = nino_monthly_re - nino_season_avg_rep;

    nino_idx = detrend(nanmean([nino_monthly_ano(12,1:end-1);nino_monthly_ano(1:2,2:end)],1))';
    nino_idx_1  = nino_idx;
    nino_monthly_ano_1 = nino_monthly_ano;
    nino_yr = find(nino_idx_1>(nanmean(nino_idx_1)+1.5*nanstd(nino_idx_1)));
    nino_yr(nino_yr==1) = []; nino_yr(nino_yr==45) = [];

   for ical = 1:size(nino_yr,1)
        TNA_nino_yr_plot = [TNA_monthly_ano(:,nino_yr(ical)-1);TNA_monthly_ano(:,nino_yr(ical));TNA_monthly_ano(:,nino_yr(ical)+1);TNA_monthly_ano(:,nino_yr(ical)+2)];
        TNA_nino_plot_final_LME(:,ical,inum) = TNA_nino_yr_plot;
        clear nino_yr_plot;
      end
      clear nino_yr; clear nino_monthly_ano_1; clear nino_idx_1 ; clear nino_idx; clear nino_monthly_ano; clear nino_season_avg_rep; clear nino_season_avg; clear nino_monthly_re; clear nino_monthly;
end
save LME_Phase_lock_TNA.mat TNA_nino_plot_final_LME;
clear; clc;

load('/Users/yingyingfeng/Downloads/Data/Paleo3bs_Project/sst_idx_850-2005_ILME_FULL_15ens.mat');
IOB_nino_plot_final_LME = nan(48,6,15);
for inum = 1:15
    IOB_monthly = sst_idx(13321:end,6,inum)-273.15; %13081 1940-2005; 1960: 13321
    IOB_monthly_re = reshape(IOB_monthly,12,size(IOB_monthly,1)./12);
    IOB_season_avg = nanmean(IOB_monthly_re,2);
    IOB_season_avg_rep = repmat(IOB_season_avg,1,size(IOB_monthly,1)./12);
    IOB_monthly_ano = IOB_monthly_re - IOB_season_avg_rep;

    nino_monthly = movmean(sst_idx(13321:end,1,inum),5)-273.15; %13081 1940-2005; 1960: 13321
    nino_monthly_re = reshape(nino_monthly,12,size(nino_monthly,1)./12);
    nino_season_avg = nanmean(nino_monthly_re,2);
    nino_season_avg_rep = repmat(nino_season_avg,1,size(nino_monthly,1)./12);
    nino_monthly_ano = nino_monthly_re - nino_season_avg_rep;

    nino_idx = detrend(nanmean([nino_monthly_ano(12,1:end-1);nino_monthly_ano(1:2,2:end)],1))';
    nino_idx_1  = nino_idx;
    nino_monthly_ano_1 = nino_monthly_ano;
    nino_yr = find(nino_idx_1>(nanmean(nino_idx_1)+1.5*nanstd(nino_idx_1)));
    nino_yr(nino_yr==1) = []; nino_yr(nino_yr==45) = [];

   for ical = 1:size(nino_yr,1)
        IOB_nino_yr_plot = [IOB_monthly_ano(:,nino_yr(ical)-1);IOB_monthly_ano(:,nino_yr(ical));IOB_monthly_ano(:,nino_yr(ical)+1);IOB_monthly_ano(:,nino_yr(ical)+2)];
        IOB_nino_plot_final_LME(:,ical,inum) = IOB_nino_yr_plot;
        clear nino_yr_plot;
      end
      clear nino_yr; clear nino_monthly_ano_1; clear nino_idx_1 ; clear nino_idx; clear nino_monthly_ano; clear nino_season_avg_rep; clear nino_season_avg; clear nino_monthly_re; clear nino_monthly;
end
save LME_Phase_lock_IOD.mat IOB_nino_plot_final_LME;
clear; clc;
%%
load phase_lock_Obs_IOD.mat plot_final plot_final_IOB plot_final_TNA plot_final_IOB;
load LME_Phase_lock_nino.mat;
% load LME_Phase_lock_TNA.mat ;
load LME_Phase_lock_IOD.mat;

year = 1:36;
fsize = 12;
page_width = 18; page_height = 18;
figure('Units','centimeters',...
    'position',[0 0 page_width page_height],...
    'PaperPosition',[0 0 page_width page_height],...
    'color',[1 1 1]);

 xstart = 0.15 ; ystart = 0.05;
 height = 0.15; width =0.7; epsx = 0.02;  epsy = 0.1;
nrow = 2; ncol = 1;
pos = zeros(nrow*ncol,4);
for r0 = 1:nrow
    for c = 1:ncol
        n = (r0-1)*ncol+c;
        pos(n,1) = xstart + (c-1)*width + (c-1)*epsx;
        pos(n,2) = 1 - (ystart + r0*height + (r0-1)*epsy);
        pos(n,3) = width;
        pos(n,4) = height;
    end
end

color_line = [[0.4 0.4 0.4]; [0 0.4470 0.7410];[0.93 0.594 0.125];[0.85 0.325 0.098]];
color_patch = [[0.3 0.3 0.3]; [0 0.4470 0.7410];[0.93 0.594 0.125];[1 0 0]];

for inum = 1:2
    ax= axes('Position',pos(inum,:),'Color','none');

    if inum ==1
        plot(year, nanmean(plot_final(13:end,:),2), '-', 'Color', 'k', 'LineWidth', 1.5, 'LineJoin' ,'miter');
        hold on;
        plot_final_plot_LME_mme = squeeze(nanmean(plot_final_LME(13:end,:,:),2));
        fh = fill([year, fliplr(year)], [(max(plot_final_plot_LME_mme,[],2))', fliplr( (min(plot_final_plot_LME_mme,[],2))' ) ], color_patch (3,:));
        set(fh,'FaceColor', color_patch(3,:),'FaceAlpha',0.15,'EdgeColor','none','EdgeAlpha',0.4,'Linestyle','--');
        hold on;
        plot(year, nanmean(plot_final_plot_LME_mme,2), '-', 'Color', color_line(3,:), 'LineWidth', 1.5, 'LineJoin' ,'miter');
        set(ax, 'YLim',[-2 4],'YTick',-2:1:4, 'TickDir','out','TickLength',[0.004/0.5, 0], 'fontname','Helvetica','fontsize',12,'yticklabel',{'-2','','0','','2','','4'});
        set(ax, 'XLim',[1 36],'XTick',1:1:36, 'TickDir','out','TickLength',[0.005/0.5, 0], 'fontname','Helvetica','fontsize',12,'xticklabel',{'Jan(0)','','','Apr(0)','','','Jul(0)','','','Oct(0)','','','Jan(1)','','','Apr(1)','','','Jul(1)','','','Oct(1)','','','Jan(2)','','','Apr(2)','','','Jul(2)','','','Oct(2)','',''});
        ylabel('Nino3.4','fontname','Helvetica','fontsize',12); 
    end

 
    if inum ==2
        plot(year, movmean(nanmean(plot_final_IOB(13:end,:),2),5), '-', 'Color','k', 'LineWidth', 1.5, 'LineJoin' ,'miter');
        hold on;
        IOB_nino_plot_final_LME_mme = squeeze(nanmean(IOB_nino_plot_final_LME(13:end,:,:),2));
        fh = fill([year, fliplr(year)], [(max(IOB_nino_plot_final_LME_mme,[],2))', fliplr( (min(IOB_nino_plot_final_LME_mme,[],2))' ) ], color_patch (3,:));
        set(fh,'FaceColor', color_patch(3,:),'FaceAlpha',0.15,'EdgeColor','none','EdgeAlpha',0.4,'Linestyle','--');
        hold on;
        plot(year, nanmean(IOB_nino_plot_final_LME_mme,2), '-', 'Color', color_line(3,:), 'LineWidth', 1.5, 'LineJoin' ,'miter');
        set(ax, 'XLim',[1 36],'XTick',1:1:36, 'TickDir','out','TickLength',[0.005/0.5, 0], 'fontname','Helvetica','fontsize',12,'xticklabel',{'Jan(0)','','','Apr(0)','','','Jul(0)','','','Oct(0)','','','Jan(1)','','','Apr(1)','','','Jul(1)','','','Oct(1)','','','Jan(2)','','','Apr(2)','','','Jul(2)','','','Oct(2)','',''});
        ylabel('IOD Index','fontname','Helvetica','fontsize',12); 
    end
  
    box off;
    %  text(2030,  -56, 'Year','Fontname','Helvetica','FontSize',9,'horizontalalignment','center' );

    box off;
    ax=gca;
    axes('position',ax.Position,'box','on','ytick',[],'xtick',[],'color','none');
end

img =gcf;
print(img, '-dtiff', '-r600', 'Phase_lock_LME_Obs_IOD1961-2004.tif');
